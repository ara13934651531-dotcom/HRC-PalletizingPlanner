#!/usr/bin/env python3
"""
HR S50-2000 Palletizing Trajectory Visualization
Generated by visualizePalletizing3D
"""

import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from matplotlib.animation import FuncAnimation

def load_trajectory(filename):
    """Load trajectory data from file."""
    data = []
    with open(filename, 'r') as f:
        for line in f:
            if line.startswith('#') or not line.strip():
                continue
            parts = line.strip().split()
            if len(parts) >= 13:
                # Format: id q1-q6 x y z rx ry rz
                waypoint = {
                    'id': int(parts[0]),
                    'joints': [float(x) for x in parts[1:7]],
                    'pose': [float(x) for x in parts[7:13]]
                }
                data.append(waypoint)
    return data

def load_obstacles(filename):
    """Load obstacle data from file."""
    obstacles = []
    with open(filename, 'r') as f:
        for line in f:
            if line.startswith('#') or not line.strip():
                continue
            parts = line.strip().split()
            if parts[0] == 'OBB' and len(parts) >= 11:
                obstacles.append({
                    'type': 'OBB',
                    'name': parts[1],
                    'pose': [float(x) for x in parts[2:8]],
                    'size': [float(x) for x in parts[8:11]]
                })
    return obstacles

def draw_box(ax, center, size, color='blue', alpha=0.3):
    """Draw a 3D box."""
    x, y, z = center[:3]
    l, w, h = size
    
    # Box vertices
    vertices = [
        [x, y, z], [x+l, y, z], [x+l, y+w, z], [x, y+w, z],
        [x, y, z+h], [x+l, y, z+h], [x+l, y+w, z+h], [x, y+w, z+h]
    ]
    
    # Box faces
    faces = [
        [0, 1, 5, 4], [1, 2, 6, 5], [2, 3, 7, 6],
        [3, 0, 4, 7], [0, 1, 2, 3], [4, 5, 6, 7]
    ]
    
    from mpl_toolkits.mplot3d.art3d import Poly3DCollection
    
    for face in faces:
        verts = [[vertices[i] for i in face]]
        ax.add_collection3d(Poly3DCollection(verts, alpha=alpha, 
                                              facecolor=color, edgecolor='black'))

def plot_trajectory_3d(trajectory, obstacles=None):
    """Create 3D visualization of trajectory."""
    fig = plt.figure(figsize=(14, 10))
    ax = fig.add_subplot(111, projection='3d')
    
    # Extract TCP positions
    x = [wp['pose'][0] for wp in trajectory]
    y = [wp['pose'][1] for wp in trajectory]
    z = [wp['pose'][2] for wp in trajectory]
    
    # Plot trajectory
    ax.plot(x, y, z, 'b-', linewidth=2, label='TCP Path')
    ax.scatter(x[0], y[0], z[0], c='green', s=100, marker='o', label='Start')
    ax.scatter(x[-1], y[-1], z[-1], c='red', s=100, marker='s', label='End')
    
    # Plot obstacles
    if obstacles:
        for obs in obstacles:
            if obs['type'] == 'OBB':
                draw_box(ax, obs['pose'], obs['size'], color='lightblue', alpha=0.2)
    
    # Robot base
    ax.scatter(0, 0, 0, c='black', s=200, marker='^', label='Robot Base')
    
    # Labels
    ax.set_xlabel('X (mm)')
    ax.set_ylabel('Y (mm)')
    ax.set_zlabel('Z (mm)')
    ax.set_title('HR S50-2000 Palletizing Trajectory')
    ax.legend()
    
    # Equal aspect ratio
    max_range = max(max(x) - min(x), max(y) - min(y), max(z) - min(z)) / 2
    mid_x = (max(x) + min(x)) / 2
    mid_y = (max(y) + min(y)) / 2
    mid_z = (max(z) + min(z)) / 2
    ax.set_xlim(mid_x - max_range, mid_x + max_range)
    ax.set_ylim(mid_y - max_range, mid_y + max_range)
    ax.set_zlim(0, mid_z + max_range)
    
    plt.tight_layout()
    plt.savefig('trajectory_3d.png', dpi=150)
    plt.show()

def plot_joint_profiles(trajectory):
    """Plot joint angle profiles."""
    fig, axes = plt.subplots(2, 3, figsize=(15, 8))
    axes = axes.flatten()
    
    t = np.arange(len(trajectory))
    joint_names = ['J1', 'J2', 'J3', 'J4', 'J5', 'J6']
    
    for i, ax in enumerate(axes):
        joints = [np.degrees(wp['joints'][i]) for wp in trajectory]
        ax.plot(t, joints, 'b-', linewidth=1.5)
        ax.set_xlabel('Waypoint')
        ax.set_ylabel(f'{joint_names[i]} (deg)')
        ax.set_title(f'Joint {i+1} Profile')
        ax.grid(True, alpha=0.3)
    
    plt.suptitle('Joint Angle Profiles', fontsize=14)
    plt.tight_layout()
    plt.savefig('joint_profiles.png', dpi=150)
    plt.show()

if __name__ == '__main__':
    import sys
    
    traj_file = 'trajectory_viz.txt' if len(sys.argv) < 2 else sys.argv[1]
    obs_file = 'scene_obstacles.txt' if len(sys.argv) < 3 else sys.argv[2]
    
    try:
        trajectory = load_trajectory(traj_file)
        print(f"Loaded {len(trajectory)} waypoints")
        
        obstacles = []
        try:
            obstacles = load_obstacles(obs_file)
            print(f"Loaded {len(obstacles)} obstacles")
        except:
            print("No obstacle file found, continuing without obstacles")
        
        plot_trajectory_3d(trajectory, obstacles)
        plot_joint_profiles(trajectory)
        
    except Exception as e:
        print(f"Error: {e}")
        print("Usage: python3 visualize_trajectory.py [trajectory_file] [obstacles_file]")
